<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SRE Incident Diagnosis</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #0d1117;
        color: #c9d1d9;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #58a6ff;
        margin-bottom: 8px;
      }
      .subtitle {
        color: #8b949e;
        margin-bottom: 24px;
      }
      .card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 16px;
      }
      .card h2 {
        margin-top: 0;
        color: #c9d1d9;
        font-size: 18px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #8b949e;
        font-size: 14px;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-size: 14px;
      }
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #58a6ff;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-primary {
        background: #238636;
        color: #fff;
      }
      .btn-primary:hover {
        background: #2ea043;
      }
      .btn-secondary {
        background: #21262d;
        color: #c9d1d9;
        border: 1px solid #30363d;
      }
      .btn-secondary:hover {
        background: #30363d;
      }
      .btn-danger {
        background: #da3633;
        color: #fff;
      }
      .btn-danger:hover {
        background: #f85149;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .sessions-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .session-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        margin-bottom: 8px;
      }
      .session-item:hover {
        border-color: #58a6ff;
      }
      .session-info {
        flex: 1;
      }
      .session-id {
        font-family: monospace;
        color: #58a6ff;
        font-size: 14px;
      }
      .session-problem {
        color: #8b949e;
        font-size: 13px;
        margin-top: 4px;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
      }
      .status-created {
        background: #1f6feb33;
        color: #58a6ff;
      }
      .status-analyzing {
        background: #a371f733;
        color: #a371f7;
      }
      .status-waiting_for_approval {
        background: #d29922cc;
        color: #0d1117;
      }
      .status-waiting {
        background: #d29922cc;
        color: #0d1117;
      }
      .status-retrieving_credentials {
        background: #1f6feb33;
        color: #58a6ff;
      }
      .status-diagnosing {
        background: #a371f733;
        color: #a371f7;
      }
      .status-approved {
        background: #23863633;
        color: #3fb950;
      }
      .status-denied {
        background: #f8514933;
        color: #f85149;
      }
      .status-completed {
        background: #23863633;
        color: #3fb950;
      }
      .status-error {
        background: #f8514933;
        color: #f85149;
      }
      .phase-progress {
        display: flex;
        gap: 8px;
        margin: 16px 0;
        align-items: center;
      }
      .phase-step {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #21262d;
        border-radius: 16px;
        font-size: 12px;
        color: #8b949e;
      }
      .phase-step.active {
        background: #1f6feb33;
        color: #58a6ff;
        border: 1px solid #1f6feb;
      }
      .phase-step.completed {
        background: #23863633;
        color: #3fb950;
      }
      .phase-step .icon {
        font-size: 14px;
      }
      .phase-connector {
        width: 20px;
        height: 2px;
        background: #30363d;
      }
      .phase-connector.completed {
        background: #3fb950;
      }
      .credential-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        font-family: monospace;
        font-size: 12px;
      }
      .credential-item .icon {
        font-size: 14px;
      }
      .credential-item.success {
        color: #3fb950;
      }
      .credential-item.pending {
        color: #8b949e;
      }
      .credential-item.failed {
        color: #f85149;
      }
      .approval-box {
        background: #341a00;
        border: 1px solid #d29922;
        border-radius: 6px;
        padding: 16px;
        margin-top: 16px;
      }
      .approval-box h3 {
        color: #d29922;
        margin-top: 0;
      }
      .approval-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }
      .findings {
        margin-top: 16px;
      }
      .finding {
        padding: 12px;
        background: #0d1117;
        border-left: 3px solid #58a6ff;
        margin-bottom: 8px;
      }
      .finding-critical {
        border-left-color: #f85149;
      }
      .finding-warning {
        border-left-color: #d29922;
      }
      .finding-info {
        border-left-color: #58a6ff;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #8b949e;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .log-output {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .log-entry {
        margin-bottom: 4px;
      }
      .log-time {
        color: #8b949e;
      }
      .log-info {
        color: #58a6ff;
      }
      .log-warn {
        color: #d29922;
      }
      .log-error {
        color: #f85149;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß SRE Incident Diagnosis</h1>
      <p class="subtitle">Autonomous infrastructure diagnosis with secure credential access</p>

      <div class="grid">
        <div class="card">
          <h2>New Diagnosis</h2>
          <form id="diagnose-form">
            <div class="form-group">
              <label for="problem">Problem Description</label>
              <textarea
                id="problem"
                placeholder="Describe the incident, e.g., 'Database connection timeouts in production API'"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="environment">Environment</label>
              <select id="environment">
                <option value="prod">Production</option>
                <option value="staging">Staging</option>
                <option value="dev">Development</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Start Diagnosis</button>
          </form>
        </div>

        <div class="card">
          <h2>Active Sessions</h2>
          <ul id="sessions-list" class="sessions-list">
            <li class="empty-state">No active sessions</li>
          </ul>
          <button id="refresh-btn" class="btn btn-secondary" style="margin-top: 12px">Refresh</button>
        </div>
      </div>

      <div class="card" id="session-detail" style="display: none">
        <h2>Session Details: <span id="detail-session-id"></span></h2>
        <div>
          <span class="status-badge" id="detail-status"></span>
          <span id="detail-phase" style="margin-left: 12px; color: #8b949e"></span>
        </div>

        <!-- Two-Phase Progress Indicator -->
        <div class="phase-progress" id="phase-progress">
          <div class="phase-step" id="phase-analysis">
            <span class="icon">üìã</span>
            <span>Analysis</span>
          </div>
          <div class="phase-connector" id="connector-1"></div>
          <div class="phase-step" id="phase-approval">
            <span class="icon">üîê</span>
            <span>Approval</span>
          </div>
          <div class="phase-connector" id="connector-2"></div>
          <div class="phase-step" id="phase-credentials">
            <span class="icon">üîë</span>
            <span>Credentials</span>
          </div>
          <div class="phase-connector" id="connector-3"></div>
          <div class="phase-step" id="phase-diagnosis">
            <span class="icon">üîß</span>
            <span>Diagnosis</span>
          </div>
        </div>

        <p id="detail-problem" style="margin-top: 12px"></p>

        <div id="approval-section" class="approval-box" style="display: none">
          <h3>‚ö†Ô∏è Credential Access Required</h3>
          <p id="approval-message">The diagnosis agent needs access to the following credentials:</p>
          <ul id="credential-list"></ul>
          <div class="approval-actions">
            <button id="approve-btn" class="btn btn-primary">‚úì Approve Access</button>
            <button id="deny-btn" class="btn btn-danger">‚úó Deny</button>
          </div>
        </div>

        <div
          id="credentials-section"
          class="card"
          style="display: none; margin-top: 16px; background: #0a1628; border: 1px solid #1f6feb"
        >
          <h3>üîë Credentials Retrieved</h3>
          <p style="font-size: 13px; color: #8b949e; margin-bottom: 8px">
            The following credentials have been securely retrieved (values are stored internally, never exposed):
          </p>
          <ul id="credentials-list" style="margin: 0; padding-left: 20px; font-family: monospace; font-size: 12px"></ul>
        </div>

        <div id="analysis-section" class="card" style="display: none; margin-top: 16px; background: #0d1117">
          <h3>Analysis</h3>
          <div id="analysis-content" style="line-height: 1.6"></div>
        </div>

        <div id="findings-section" class="findings" style="display: none">
          <h3>Findings</h3>
          <div id="findings-list"></div>
        </div>

        <div class="log-output" id="log-output" style="margin-top: 16px">
          <div class="log-entry"><span class="log-time">[--:--:--]</span> Waiting for activity...</div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "";
      let currentSessionId = null;
      let pollInterval = null;

      // Format timestamp
      function formatTime(date) {
        return date.toTimeString().split(" ")[0];
      }

      // Add log entry
      function addLog(message, level = "info") {
        const logOutput = document.getElementById("log-output");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `<span class="log-time">[${formatTime(new Date())}]</span> <span class="log-${level}">${message}</span>`;
        logOutput.appendChild(entry);
        logOutput.scrollTop = logOutput.scrollHeight;
      }

      // Clear logs
      function clearLogs() {
        document.getElementById("log-output").innerHTML = "";
      }

      // Fetch sessions
      async function fetchSessions() {
        try {
          const response = await fetch(`${API_BASE}/sessions`);
          const data = await response.json();
          renderSessions(data.sessions);
        } catch (error) {
          console.error("Failed to fetch sessions:", error);
        }
      }

      // Render sessions list
      function renderSessions(sessions) {
        const list = document.getElementById("sessions-list");
        if (sessions.length === 0) {
          list.innerHTML = '<li class="empty-state">No active sessions</li>';
          return;
        }
        list.innerHTML = sessions
          .map(
            (s) => `
                <li class="session-item" onclick="selectSession('${s.session_id}')">
                    <div class="session-info">
                        <div class="session-id">${s.session_id}${s.credentials_retrieved > 0 ? " üîë" + s.credentials_retrieved : ""}</div>
                        <div class="session-problem">${s.problem}</div>
                    </div>
                    <span class="status-badge status-${s.status}">${s.status}</span>
                </li>
            `,
          )
          .join("");
      }

      // Select session
      async function selectSession(sessionId) {
        currentSessionId = sessionId;
        document.getElementById("session-detail").style.display = "block";
        document.getElementById("detail-session-id").textContent = sessionId;
        clearLogs();
        addLog(`Selected session ${sessionId}`, "info");
        await updateSessionDetail();
        startPolling();
      }

      // Update phase progress indicator
      function updatePhaseProgress(phase, status) {
        const phases = ["analysis", "approval", "credentials", "diagnosis"];
        const phaseMap = {
          analyzing: 0,
          analysis: 0,
          awaiting_approval: 1,
          waiting_for_approval: 1,
          credential_retrieval: 2,
          retrieving_credentials: 2,
          diagnosis: 3,
          diagnosing: 3,
          diagnosis_complete: 4,
          completed: 4,
          error: -1,
          denied: -1,
          credentials_denied: -1,
        };

        const currentPhase = phaseMap[phase] ?? phaseMap[status] ?? 0;

        phases.forEach((p, i) => {
          const stepEl = document.getElementById(`phase-${p}`);
          const connectorEl = document.getElementById(`connector-${i + 1}`);

          if (i < currentPhase) {
            stepEl.className = "phase-step completed";
            if (connectorEl) connectorEl.className = "phase-connector completed";
          } else if (i === currentPhase && currentPhase < 4) {
            stepEl.className = "phase-step active";
            if (connectorEl) connectorEl.className = "phase-connector";
          } else {
            stepEl.className = "phase-step";
            if (connectorEl) connectorEl.className = "phase-connector";
          }
        });

        // Special handling for completed state
        if (status === "completed" || phase === "diagnosis_complete") {
          phases.forEach((p, i) => {
            document.getElementById(`phase-${p}`).className = "phase-step completed";
            const conn = document.getElementById(`connector-${i + 1}`);
            if (conn) conn.className = "phase-connector completed";
          });
        }
      }

      // Update session detail
      async function updateSessionDetail() {
        if (!currentSessionId) return;

        try {
          const response = await fetch(`${API_BASE}/status/${currentSessionId}`);
          const data = await response.json();

          document.getElementById("detail-status").textContent = data.status;
          document.getElementById("detail-status").className = `status-badge status-${data.status}`;
          document.getElementById("detail-phase").textContent = `Phase: ${data.phase}`;

          // Update phase progress indicator
          updatePhaseProgress(data.phase, data.status);

          // Show approval section if waiting
          const approvalSection = document.getElementById("approval-section");
          if (data.phase === "awaiting_approval" || data.status === "waiting_for_approval") {
            approvalSection.style.display = "block";
            if (data.approval_prompt) {
              document.getElementById("approval-message").textContent = data.approval_prompt;
            }
          } else {
            approvalSection.style.display = "none";
          }

          // Show credentials retrieved section
          const credsSection = document.getElementById("credentials-section");
          if (credsSection && data.credentials_retrieved && data.credentials_retrieved.length > 0) {
            credsSection.style.display = "block";
            document.getElementById("credentials-list").innerHTML = data.credentials_retrieved
              .map((ref) => `<li><code>${ref}</code></li>`)
              .join("");
          } else if (credsSection) {
            credsSection.style.display = "none";
          }

          // Show analysis if available
          if (data.analysis) {
            const analysisSection = document.getElementById("analysis-section");
            if (analysisSection) {
              analysisSection.style.display = "block";
              document.getElementById("analysis-content").innerHTML = formatMarkdown(data.analysis);
            }
          }

          // Show findings if available
          if (data.findings && data.findings.length > 0) {
            document.getElementById("findings-section").style.display = "block";
            document.getElementById("findings-list").innerHTML = data.findings
              .map(
                (f) => `
                        <div class="finding finding-${f.severity || "info"}">
                            <strong>${f.title || "Finding"}</strong>
                            <p>${f.description || f}</p>
                        </div>
                    `,
              )
              .join("");
          }
        } catch (error) {
          addLog(`Error fetching status: ${error.message}`, "error");
        }
      }

      // Start polling for updates
      function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(updateSessionDetail, 2000);
      }

      // Stop polling
      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }

      // Simple markdown formatter
      function formatMarkdown(text) {
        if (!text) return "";
        return text
          .replace(/^## (.+)$/gm, "<h3>$1</h3>")
          .replace(/^### (.+)$/gm, "<h4>$1</h4>")
          .replace(/^\- (.+)$/gm, "<li>$1</li>")
          .replace(/^\d+\. (.+)$/gm, "<li>$1</li>")
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/\n/g, "<br>");
      }

      // Stream NDJSON response
      async function streamResponse(response, onChunk) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split("\n");
          buffer = lines.pop() || "";

          for (const line of lines) {
            if (line.trim()) {
              try {
                const data = JSON.parse(line);
                onChunk(data);
              } catch (e) {
                console.warn("Failed to parse line:", line);
              }
            }
          }
        }
      }

      // Submit diagnosis form
      document.getElementById("diagnose-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const problem = document.getElementById("problem").value;
        const environment = document.getElementById("environment").value;

        if (!problem.trim()) {
          alert("Please describe the problem");
          return;
        }

        try {
          addLog("Starting diagnosis...", "info");
          const response = await fetch(`${API_BASE}/diagnose`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ problem, environment }),
          });

          // Stream the response
          await streamResponse(response, (data) => {
            if (data.type === "session_start") {
              addLog(`üöÄ Session ${data.session_id} started - Phase 1: Analysis`, "info");
              currentSessionId = data.session_id;
              document.getElementById("session-detail").style.display = "block";
              document.getElementById("detail-session-id").textContent = data.session_id;
              updatePhaseProgress("analysis", "analyzing");
              fetchSessions();
            } else if (data.type === "approval_required") {
              addLog(`üîê Analysis complete - ${data.requested_credentials?.length || 0} credentials requested`, "warn");
              document.getElementById("approval-section").style.display = "block";
              document.getElementById("approval-message").textContent =
                `The agent needs access to ${data.requested_credentials?.length || 0} credentials to complete diagnosis:`;
              updatePhaseProgress("awaiting_approval", "waiting_for_approval");
              updateSessionDetail();
              fetchSessions();
            } else if (data.type === "session_complete") {
              addLog("‚úÖ Analysis complete", "info");
              updateSessionDetail();
              fetchSessions();
            } else if (data.type === "error") {
              addLog(`‚ùå Error: ${data.message}`, "error");
            } else if (data.text) {
              // Streaming text content - show abbreviated (skip timestamps)
              const preview = data.text.replace(/\n/g, " ").substring(0, 60);
              if (preview.trim() && !preview.match(/^\d{4}-\d{2}-\d{2}/)) {
                addLog(`üìù ${preview}${data.text.length > 60 ? "..." : ""}`, "info");
              }
            }
          });

          document.getElementById("problem").value = "";
        } catch (error) {
          addLog(`Failed to start diagnosis: ${error.message}`, "error");
        }
      });

      // Approve credentials
      document.getElementById("approve-btn").addEventListener("click", async () => {
        if (!currentSessionId) return;
        try {
          addLog("Sending approval...", "info");
          document.getElementById("approval-section").style.display = "none";

          const response = await fetch(`${API_BASE}/approve/${currentSessionId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ approved: true, message: "approve" }),
          });

          // Stream the resumed agent response
          let credentialCount = 0;
          let specialistCount = 0;
          await streamResponse(response, (data) => {
            if (data.type === "approval_accepted") {
              addLog("‚úÖ Credentials approved - Phase 2: Retrieving credentials...", "info");
              updatePhaseProgress("credential_retrieval", "retrieving_credentials");
            } else if (data.type === "credential_retrieved") {
              credentialCount++;
              const icon = data.success ? "üîë" : "‚ùå";
              const status = data.success ? "retrieved" : "failed";
              addLog(
                `${icon} Credential ${credentialCount}: ${data.reference} - ${status}`,
                data.success ? "info" : "error",
              );
            } else if (data.type === "diagnosis_started") {
              addLog(`üîß Starting diagnosis with ${data.credentials_retrieved} credentials...`, "info");
              updatePhaseProgress("diagnosis", "diagnosing");
            } else if (data.type === "specialists_selected") {
              const specialists = data.specialists || [];
              addLog(`ü§ñ Running ${specialists.length} specialist agents: ${specialists.join(", ")}`, "info");
            } else if (data.type === "specialist_complete") {
              specialistCount++;
              const agentName = data.agent?.replace("_specialist", "") || "unknown";
              const icon = data.status === "completed" ? "‚úÖ" : "‚ö†Ô∏è";
              addLog(`${icon} Specialist #${specialistCount} (${agentName}): ${data.status}`, "info");
            } else if (data.type === "specialist_error") {
              addLog(`‚ùå Specialist error: ${data.error}`, "error");
            } else if (data.type === "synthesis_started") {
              addLog("üß™ Synthesizing findings from all specialists...", "info");
            } else if (data.type === "diagnosis_complete") {
              addLog("‚úÖ Diagnosis complete!", "info");
              updatePhaseProgress("diagnosis_complete", "completed");
              updateSessionDetail();
              fetchSessions();
            } else if (data.type === "error") {
              addLog(`‚ùå Error: ${data.message}`, "error");
            } else if (data.text) {
              // Show diagnosis output (skip timestamps)
              const preview = data.text.replace(/\n/g, " ").substring(0, 80);
              if (preview.trim() && !preview.match(/^\d{4}-\d{2}-\d{2}/)) {
                addLog(`üìã ${preview}${data.text.length > 80 ? "..." : ""}`, "info");
              }
            }
          });

          await updateSessionDetail();
          await fetchSessions();
        } catch (error) {
          addLog(`Approval failed: ${error.message}`, "error");
        }
      });

      // Deny credentials
      document.getElementById("deny-btn").addEventListener("click", async () => {
        if (!currentSessionId) return;
        try {
          await fetch(`${API_BASE}/approve/${currentSessionId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ approved: false }),
          });
          addLog("Credentials denied", "warn");
          await updateSessionDetail();
          await fetchSessions();
        } catch (error) {
          addLog(`Denial failed: ${error.message}`, "error");
        }
      });

      // Refresh button
      document.getElementById("refresh-btn").addEventListener("click", fetchSessions);

      // Initial load
      fetchSessions();
    </script>
  </body>
</html>
