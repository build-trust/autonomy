name: Nix Cache
description: Cache Nix File To Temporary Directory

runs:
  using: composite
  steps:
    - shell: bash
      run: |
        sudo systemctl stop nix-daemon
        sudo chown -R "${USER}:" /nix

        # Create cache directory and copy nix store contents
        sudo mkdir -p /tmp/nix-cache

        # Copy store contents directly to cache root
        if [ -d /nix/store ]; then
          sudo cp -r /nix/store /tmp/nix-cache/
        fi

        # Copy database
        if [ -d /nix/var/nix/db ]; then
          sudo mkdir -p /tmp/nix-cache/var/nix
          sudo cp -r /nix/var/nix/db /tmp/nix-cache/var/nix/
        fi

        # Copy profiles
        if [ -d /nix/var/nix/profiles ]; then
          sudo mkdir -p /tmp/nix-cache/var/nix
          sudo cp -r /nix/var/nix/profiles /tmp/nix-cache/var/nix/
        fi

        sudo rm -rf /nix
